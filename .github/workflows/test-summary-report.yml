name: Test summary report
on:
  push:
    branches:
      - summary-report-action
  pull_request:
  workflow_dispatch:

jobs:
  show_markdown:
    runs-on: ubuntu-20.04
    env:
      OUTPUT_FILE_PATH: "summary_report.md"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Init and run scan action
        uses: Traceableai/ast-action@main
        with:
          step_name: 'init and run'
          client_scan_token: ${{ secrets.CLIENT_SCAN_TOKEN_DEMO }}
          cli_version: 'latest'
          traffic_env: 'crapi-demo1'
          traceable_server: ${{ secrets.TRACEABLE_SERVER_DEMO }}
          output_format: 'md'
          output_file: ${{ env.OUTPUT_FILE_PATH }}
          idle_timeout: '1'
      - name: Stop Scan
        if: always()
        uses: Traceableai/ast-action@main
        with:
          step_name: 'stop'
          client_scan_token: ${{ secrets.CLIENT_SCAN_TOKEN_DEMO }}
          traffic_env: 'crapi-demo1'
          traceable_server: ${{ secrets.TRACEABLE_SERVER_DEMO }}
      
      # - name: Display Report
      #   run: echo ${{ env.OUTPUT_FILE_PATH }} >> $GITHUB_STEP_SUMMARY

      # - name: Display Report
      #   run: |
      #     report=$(cat ${{ env.OUTPUT_FILE_PATH }})
      #     echo "::set-env name=GITHUB_STEP_SUMMARY::$report"
      #   shell: bash

      
      # - name: Display Markdown File in Workflow Summary
      #   uses: actions/github-script@v3
      #   with:
      #     script: |
      #       const markdown = '${{ steps.Read_Markdown_File.outputs.markdown }}';
      #       github.workflow.update({
      #         status: "completed",
      #         conclusion: "success",
      #         output: {
      #           title: "My Markdown File",
      #           summary: markdown
      #         }
      #       })
  # generate-report:
  #   runs-on: ubuntu-20.04
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3

  #     - name: Set up Python
  #       uses: actions/setup-python@v3
  #       with:
  #         python-version: "3.9"

  #     - name: Install dependencies
  #       run: pip install junitparser

  #     - name: Generate JUnit report
  #       run: python generate_report.py

  #     - name: Upload JUnit report
  #       uses: actions/upload-artifact@v2
  #       with:
  #         name: junit-report
  #         path: report.xml

  # display-report:
  #   needs: generate-report
  #   runs-on: ubuntu-latest
  #   steps:
  #     # - name: Disable Debug Logs
  #     #   env:
  #     #     ACTIONS_STEP_DEBUG: 'false'

  #     - name: Download JUnit report
  #       uses: actions/download-artifact@v2
  #       with:
  #         name: junit-report

  #     # - name: Debug report file
  #     #   run: cat report.xml
          
  #     - name: Display JUnit report
  #       uses: mikepenz/action-junit-report@v3
  #       with:
  #         report_paths: junit-report/report.xml

  #     # - name: Publish JUnit test results
  #     #   uses: EnricoMi/publish-unit-test-result-action@v2
  #     #   # with:
  #     #   #   test_results_files: report.xml
  #     #   #   check_run_name: My Test Results
  #     #   #   fail_on_error: true
      